

# 盒子设备上机指南

## 设备要求
- 系统：Android / OpenWrt
- 单线带宽：>= 20M
- 网络：
  - IPv4（公网、NAT1、NAT3）  
  **或者**  
  - IPv4（NAT4） + IPv6


## 上机流程

### 1. Agent 安装包下载
- [在爱思琴github](https://github.com/aisiqintech/)下载对应盒子设备的 agent 安装包，例如：edge-provider-xxx.run
### 2. 部署

#### 2.1 解压 Agent 程序
- 执行安装程序并指定工作目录：

```bash
export PCDN_AGENT_RUN_PATH=XXXXX 
chmod a+x edge-provider-installer-xxxx.run
./edge-provider-installer-xxxx.run
````
**参数说明：**
* `PCDN_AGENT_RUN_PATH`（必填）：Agent 程序工作目录，必须设置在安装目录。Agent 会以 `./bin` 或 `./data` 这样的相对路径访问自己的数据。

#### 2.2 启动 Agent
* 进入工作目录：
  ```bash
  cd $PCDN_AGENT_RUN_PATH
  ```
* 设置系统网络缓冲区大小（必须 >= 8M，否则业务跑量会受影响）：

  ```bash
  echo 16777216 > /proc/sys/net/core/rmem_max
  echo 16777216 > /proc/sys/net/core/wmem_max
  echo 16777216 > /proc/sys/net/core/rmem_default
  echo 16777216 > /proc/sys/net/core/wmem_default
  ```
  > 提示：重启会失效，可在启动脚本里设置。
* 启动 Agent：
  ```bash
  export PCDN_AGENT_RUN_PATH=XXX
  export PCDN_RESOURCE_PATH=XXX 
  export PCDN_RESOURCE_LIMIT=XXX
  export PCDN_IFNAME=XXX
  export PCDN_BANDWIDTH=XXX
  export PCDN_TRANS_MODE=XXX
  export PCDN_SN=XXX
  export $PCDN_AGENT_RUN_PATH/bin/edge-provider-agent-loader
  ```

#### 2.3 启动参数说明

| 参数                    | 是否必填 | 说明                                                                             |
| --------------------- | ---- | ------------------------------------------------------------------------------ |
| `PCDN_AGENT_RUN_PATH` | 必填   | Agent 程序工作目录，必须设置在安装目录                                                         |
| `PCDN_RESOURCE_PATH`  | 必填   | 点播下载资源存放目录                                                                     |
| `PCDN_RESOURCE_LIMIT` | 选填   | 点播资源最大存储空间，默认单位 G，不填写则自动检测可用大小                                                 |
| `PCDN_IFNAME`         | 必填   | 业务使用的网卡名称，Agent 用于采集数据                                                         |
| `PCDN_BANDWIDTH`      | 必填   | 分配给业务的最大上行带宽，单位 Mbps                                                           |
| `PCDN_TRANS_MODE`     | 必填   | 传输模式：<br>1：全国全运营商<br>2：省内任意运营商<br>3：省内同运营商，跨省跨运营商<br>4：省内任意，跨省跨运营商<br>5：同省同运营商 |
| `PCDN_SN`             | 必填   | 唯一标识设备，32-64 位，全局 ID，不要重复，随机数中间不要特殊符号                                          |
| `PCDN_AGENT_PORT`     | 选填   | Agent 监听 TCP 端口，默认 8080，如端口被占用，可设置 1024~65535                                  |

---

### 3. Agent 保活

* **子进程守护**：

  * 监听进程退出返回码：

    * 非 0：自动重启
    * 0：无需重启（仅在管理平台发起“删除”指令时）
* **轮询守护**：

  * 注意进程名称是 `edge-provider-agent`，而不是 `edge-provider-agent-loader`
* 确保 `PCDN_AGENT_RUN_PATH` 工作目录正确设置
